\documentclass[problem]{mcs}

\begin{pcomments}
  \pcomment{from: S04.ps6}
\end{pcomments}

\pkeywords{
   %I don't know the format for these keywords, how do I look them up?
	state_machines
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Problem starts here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{problem} %from S04, ps6; adapted from F03 Final, 

The Massachusetts Turnpike Authority is concerned about the integrity of
the new Zakim bridge.  Their consulting architect has warned that the
bridge may collapse if more than 1000 cars are on it at the same time.
The Authority has also been warned by their traffic consultants that the
rate of accidents from cars speeding across bridges has been increasing.

Both to lighten traffic and to discourage speeding, the Authority has
decided to make the bridge \emph{one-way} and to put tolls at \emph{both}
ends of the bridge (don't laugh, this is Massachusetts).  So cars will pay
tolls both on entering and exiting the bridge, but the tolls will be
different.  In particular, a car will pay \$3 to enter onto the bridge and
will pay \$2 to exit.  To be sure that there are never too many cars on
the bridge, the Authority will let a car onto the bridge only if the
difference between the amount of money currently at the entry toll booth
minus the amount at the exit toll booth is strictly less than a certain
threshold amount of \$$T_0$.

The consultants have decided to model this scenario with a state
machine whose states are triples of natural numbers, $(A,B,C)$, where
\begin{itemize}
\item $A$ is an amount of money at the entry booth,
\item $B$ is an amount of money at the exit booth, and
\item $C$ is a number of cars on the bridge.
\end{itemize}
Any state with $C>1000$ is called a \emph{collapsed} state, which the
Authority dearly hopes to avoid.  There will be no transition out of a
collapsed state.

Since the toll booth collectors may need to start off with some amount of
money in order to make change, and there may also be some number of
``official'' cars already on the bridge when it is opened to the public,
the consultants must be ready to analyze the system started at \emph{any}
state.  So let $A_0$ be the initial number of dollars at the entrance toll
booth, $B_0$ the initial number of dollars at the exit toll booth, and
$C_0$ the number of official cars on the bridge when it is opened.  The
Authority will be careful to ensure that $C_0$ is not large enough to
cause a collapse.  You should assume that even official cars pay tolls on
exiting or entering the bridge after the bridge is opened.

\bparts

\problempart Give a mathematical model of the Authority's system for
letting cars on and off the bridge by specifying a transition relation
between states of the form $(A,B,C)$ above.  

\begin{solution}
State $(A,B,C)$ goes to state
\begin{enumerate}
\item[(i)] $(A+3,B,C+1)$, provided that $A-B<T_0$ and $C < 1000$.  This
transition models the case where a car enters the bridge.

\item[(ii)] $(A,B+2,C-1)$, provided that $0 < C \leq 1000$.  This
transition models the case where a car leaves the bridge.

\end{enumerate}
\end{solution}
 
\problempart\label{variables}
Characterize each of the following derived variables
\[
A, B, A+B, A-B, 3C-A, 2 A - 3 B, B+3C, 2A - 3B - 6C, 
2A - 2B - 3C
\]
as one of the following
\begin{center}
\begin{tabular}{|ll|} \hline
constant              & C  \\  
strictly increasing   & SI \\
strictly decreasing   & SD \\
weakly increasing but not constant & WI \\
weakly decreasing but not constant & WD \\
 none of the above     & N  \\\hline
\end{tabular}
\end{center}
and briefly explain your reasoning.

\begin{solution}

%$A$ WI,
%$B$ WI,
%$A+B$  SI,
%$A-B$ N,
%$3C-A$ WD,
%$2A - 3B$ N,
%$B+3C$ WI,
%$2A - 3B - 6C$ C,
%$2A - 2B - 3C$ N

In every transition, at least one of $A$ and $B$ increases. So
their sum is strictly increasing.  $2A-3B$ can fluctuate, going up on (i)
and down on (ii).

The difference $3C-A$ doesn't change under transitions of type~(i), but
decreases under transitions of type~(ii); so is weakly decreasing.
Likewise, $B+3C$ doesn't change under transitions of type~(ii), but
increases under transitions of type~(i); so is weakly increasing.

On the other hand, $6C$ and $2A-3B$ simultaneously increase by 6 under
transition (i) or simultaneously decrease by 6 under transition (ii),
which makes their difference constant.

Finally, under (i), $2A$ increases by 6, $B$ is unchanged, and $3C$
increases by 3, so $2A-2B-3C$ increases by $6-3 =3$.  However, under (ii),
$A$ is unchanged, $3C$ decreases by 3 and $2B$ increases by 4, so $2A-2B-3C$
decreases by $-(-4) - 3 = 1$.

The completed table follows.
\[
\renewcommand{\arraystretch}{2}
\begin{array}{|c|c|} \hline
A                 & WI \\\hline 
B                 & WI \\\hline 
A+B               & SI \\\hline 
A-B               & N  \\\hline 
3C-A              & WD \\\hline
2A - 3B           & N \\\hline 
B+3C              & N \\\hline 
2A - 3B - 6C      & C  \\\hline
2A - 2B -3C       & N \\\hline
\end{array}
\]
\end{solution}

\eparts

The Authority has asked their engineering consultants to determine $T$ and
to verify that this policy will keep the number of cars from exceeding
1000.

The consultants reason that if $A_0$ is the initial number of dollars at
the entrance toll booth, $B_0$ is the initial number of dollars at the
exit toll booth, and $C_0$ is the number of official cars on the bridge
when it is opened, then an additional $1000-C_0$ cars can be allowed on the
bridge, so as long as $A-B$ has not increased by $3(1000-C_0)$ there
shouldn't more than 1000 cars on the bridge.  So they recommend defining
\[
T_0 \eqdef 3(1000-C_0) + (A_0 - B_0).
\]

\bparts

\problempart Use the results of part~(\ref{variables}) to define a
simple predicate, $P$, on states of the transition system which is
satisfied by the start state, that is $P(A_0,B_0,C_0)$ holds, is not
satisfied by any collapsed state, and is an \emph{invariant} of the
system.  Verify that the $P$ you define has these properties.

\begin{solution}
Let $D_0 \eqdef 2A_0 - 3B_0 - 6C_0$.

\textbf{Invariant:} $[2A - 3B - 6C =  D_0] \land [C \leq 1000]$.

The invariant obviously holds at the state $(A_0,B_0,C_0)$ because we know
that $C_0 \leq 1000$.  It does not hold in any collapsed state.  To verify
the Invariant, assume $(A,B,C)$ satisfies the Invariant and has a
transition to $(A',B',C')$.  We check that $(A',B',C')$ satisfies the
Invariant by considering the two kinds of transitions.

Transition (i) (a car enters the bridge): so
\[
6C' = 6(C + 1) = 6C + 6 = (2A-3B-D_0) + 6 = 2(A+3)-3B-D_0=
2A' - 3B' -D_0,
\]
which implies that
\begin{equation}\label{2A}
2A' - 3B' - 6 C' =  D_0,
\end{equation}
as required.

Also, the transition is possible only if $A-B < T_0$.
But this implies
\begin{align*}
6C' & = 2A' -  3B' - D_0 & \text{(by~(\ref{2A}))}\\
& = 2(A'- B') - B' - D_0\\
& = 2((A+3) - B) - B - D_0 & \text{(since $A'=A+3$, $B'=B$)}\\
& = 2(A-B) - B - D_0 + 6\\
& \leq 2(A - B) - B_0 -D_0 + 6 &\text{(since $B$ is WI)}\\
& \leq 2(T_0 - 1) -B_0 -D_0 + 6 & \text{(since $A-B \leq T_0 - 1$)}\\
&= 2[3(1000-C_0) + (A_0 - B_0)] -B_0 -D_0+4\\
&=6000 -6C_0 +2A_0-3B_0 -D_0+4\\
& =6004,
\end{align*}
and so $C' \leq \floor{6004/6} = 1000$, as required.
Transition (ii) (a car leaves the bridge): so
\[
6C' = 6(C - 1) = 6C - 6= 2A-3B - 6= 2A - 3(B+3) = 2A' - 3B'.
\]
In addition, $C' < C \leq 1000$ so $C' \leq 1000$.
\end{solution}
\problempart A clever MIT intern working for the Turnpike Authority agrees
that the Turnpike's bridge management policy will be \emph{safe}: the
bridge will not collapse.  But she warns her boss that the policy will
lead to \emph{deadlock}--- a situation where traffic can't move on the
bridge even though the bridge has not collapsed.

Explain more precisely in terms of system transitions what the intern
means, and briefly, but clearly, justify her claim.

\begin{solution}

%%%REVISE

The intern means that any sequence of transitions will arrive at a state
in which no transition is possible, even though there are no cars on the
bridge.  This happens because every time a car enters and then exits the
bridge the value of $A-B$ increases by 1.  So after 3000 cars have crossed
the bridge, no further car can enter the bridge because
\[
A-B \geq 3000 + A_0-B_0 \geq 3(1000-C_0) + (A_0 - B_0) = T_0.
\]
After that, cars can only exit the bridge.  So after at most 3000+1000
transitions, the system deadlocks with the bridge empty but no cars
allowed onto the bridge.
\end{solution}

\eparts
\end{problem}

