\documentclass[problem]{mcs}

\begin{pcomments}
  \pcomment{PS_derangement}
  \pcomment{from: S08 ps9}
\end{pcomments}

\pkeywords{
  inclusion-exclusion
  counting
  bijection
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Problem starts here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{problem}
A \emph{derangement} is a permutation $(x_1, x_2, \dots, x_n)$ of
the set $\set{1, 2, \dots, n}$ such that $x_i \neq i$ for all $i$.
For example, $(2, 3, 4, 5, 1)$ is a derangement, but $(2, 1, 3, 5, 4)$
is not because 3 appears in the third position.  The objective of this
problem is to count derangements.

It turns out to be easier to start by counting the permutations that are
\emph{not} derangements.  Let $S_i$ be the set of all permutations
$(x_1, x_2, \dots, x_n)$ that are not derangements because $x_i = i$.
So the set of non-derangements is
\[
\lgunion_{i=1}^n S_i.
\]

\bparts

\ppart What is $\card{S_i}$?

\begin{solution}
There is a bijection between permutations of $\set{1, 2,
\dots, n}$ with $i$ in the $i$-th position and unrestricted
permutations of $\set{1, 2, \dots, n} - i$.  Therefore, $\card{S_i} =
(n-1)!$.
\end{solution}

\ppart What is $\Card{S_i \cap S_j}$ where $i \neq j$?

\begin{solution}
The set $S_i \cap S_j$ consists of all permutations with $i$
in the $i$-th position and $j$ in the $j$-th position.  Thus, there is
a bijection with permutations of $\set{1, 2, \dots, n} - \set{i, j}$,
and so $\Card{S_i \cap S_j} = (n-2)!$.
\end{solution}

\ppart What is $\Card{S_{i_1} \cap S_{i_2} \cap \cdots \cap S_{i_k}}$
where $i_1, i_2, \dots, i_k$ are all distinct?

\begin{solution}
By the same argument, $(n - k)!$.
\end{solution}

\ppart\label{ie} Use the inclusion-exclusion formula to express the number of
non-derangements in terms of sizes of possible intersections of the sets
$S_1, \dots, S_n$.

\begin{solution}
\[
\sum_i \card{S_i}
- \sum_{i,j} \Card{S_i \cap S_j}
+ \sum_{i,j,k} \Card{S_i \cap S_j \cap S_k}
- \cdots
\pm \Card{S_1 \cap S_2 \cap \cdots \cap S_n}
\]
%
In each summation, the subscripts are distinct elements of $\set{1,
\dots, n}$.
\end{solution}

\ppart How many terms in the expression in part~\eqref{ie} have the form
\[
\Card{S_{i_1} \cap S_{i_2} \cap \cdots \cap S_{i_k}}?
\]

\begin{solution}
There is one such term for each $k$-element subset of the
$n$-element set $\set{1, 2, \dots, n}$.  Therefore, there are
$\binom{n}{k}$ such terms.
\end{solution}

\ppart Combine your answers to the preceding parts to prove the number of
non-derangements is:
\[
n! \paren{\frac{1}{1!} - \frac{1}{2!} + \frac{1}{3!} - \cdots \pm \frac{1}{n!}}.
\]
Conclude that the number of derangements is
\[
n! \paren{1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \cdots \pm \frac{1}{n!}}.
\]

\begin{solution}
By Inclusion-Exclusion, the number of non-derangements is
\begin{align}
\lefteqn{\sum_i \card{S_i}
- \sum_{i,j} \Card{S_i \cap S_j}
+ \sum_{i,j,k} \Card{S_i \cap S_j \cap S_k}
- \cdots
\pm \Card{S_1 \cap S_2 \cap \cdots \cap S_n}} \notag \\
    & = \binom{n}{1} \cdot (n-1)!
      - \binom{n}{2} \cdot (n-2)!
      + \binom{n}{3} \cdot (n-3)!
      - \cdots
      \pm \binom{n}{n} \cdot 0! \notag\\
    & = n! \paren{\frac{1}{1!} - \frac{1}{2!} + \frac{1}{3!} - \cdots \pm \frac{1}{n!}}\label{nd}
\end{align}

Since there are $n!$ permutation, the number of derangements is $n!$
minus expression~\eqref{nd}.
\end{solution}

\ppart As $n$ goes to infinity, the number of derangements approaches
a constant fraction of all permutations.  What is that constant?
\hint
%
\[
e^x = 1 + x + \frac{x^2}{2!} + \frac{x^3}{3!} + \cdots
\]

\begin{solution}
$1/e$
\end{solution}

\eparts

\end{problem}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Problem ends here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\endinput
